# **英才计划 9-10月月报**
tqz_ 2023/10/29
## **概要**
在这段时间内，我重点对AI图像生成 **Stable Diffusion** 进行了了解。具体包括：
- 阅读了三篇论文。
- 安装并尝试使用了 **Stable Diffusion** 和 **ControlNet** ，了解了其生成图像的全过程。
- 训练了一个 **Stable Diffusion Lora** 模型。
## **阅读论文**
### Lora
这篇文章介绍了一种名为LoRA（Low-Rank Adaptation）的低秩适应方法，用于大语言模型的参数优化。在传统的模型微调方法中，需要重新训练所有模型参数，但随着模型规模的增大，这种方法消耗资源较大。LoRA方法通过冻结预训练模型的权重，并在全连接层中注入可训练的秩分解矩阵，从而大大减少了下游任务的可训练参数数量。对于使用者来说，Lora模型大小通常只有几MB、几十MB，且同一个Lora模型可以用于结构相同的不同模型，大大减少了模型微调的工作量。  
在论文中，Lora被应用在大语言模型中，其性能和优势得以验证。之后，社区中有人成功将Lora应用在 **Stable Diffusion** 中。
### ControlNet
这篇文章主要介绍了一种在文本到图像扩散模型中添加条件控制的方法，称为ControlNet。ControlNet通过将额外的条件注入到神经网络中，实现对图像生成过程的控制。文章中提到，ControlNet可以有效地控制稳定扩散模型，具有单一或多个条件的能力，并且可以处理各种不同的输入条件。实验结果表明，ControlNet在生成图像时能够产生清晰、锐利的结果，并且对于不同的条件具有较好的适应性。  
具体而言， Controlnet 通过将 Stable Diffusion 模型的 Encoder 部分参数冻结，创建一个可训练的副本，将外部的额外控制向量输入这个副本，然后将这个 Encoder 的结果传到 Stable Diffusion 的 Decoder 中，以此实现外部控制向量对生成结果的控制。  
![Alt text](1-3.jpg)  

### Nightshade
这篇文章介绍了一种名为 Nightshade 的优化的特定提示毒化攻击方法，其中毒化样本在视觉上与具有相匹配文本提示的良性图像完全相同。Nightshade毒化样本还经过优化，可以在少于100个毒化样本中破坏Stable Diffusion SDXL模型的提示。Nightshade毒化效果会“渗透”到相关概念中，多个攻击可以组合在一个提示中。作者展示了适度数量的 Nightshade 攻击可以破坏文本到图像生成模型的一般特征，有效地使其无法生成有意义的图像。  
具体来说，Stable Diffusion text-to-image的训练是通过图片及其对应的正确的文字描述训练模型参数的。由于训练需要庞大的数据集，不可能每张图片都通过人工来编写其对应的文字描述，所以现在训练扩散模型大多采用 CLIP 等 image-to-text 模型自动生成图片的对应文字描述。 Nightshade 通过给原图添加微小扰动，使得原图在被 CLIP 等模型的交叉注意力层处理后向另一个不相关的概念靠近。论文中的一张图展示了这种扰动的效果。  
![Alt text](2-3.jpg)  
如此一来，以第一行为例，一张帽子的图像会被CILP识别为一根香蕉，在后续训练过程中，Stable Diffusion 参数会被调整，尝试将帽子的图像和香蕉联系在一起，而这样做显然是错误的。经过一定有毒图片的引导，模型最后将无法正常生成图像。由于相似语义的文本会被转化为相似的特征向量，因此这种攻击方法对于相似语义的图像都有攻击作用。  
![Alt text](3-1.jpg)  
然而我个人认为，针对这种攻击方法，训练者也可以有相应的应对措施，能弱化甚至消除这种攻击的影响。在预处理训练集时，只需将图片使用image-to-image 模型对图片作出一定的扰动，那么 Nightshade 攻击所作出的扰动也许能够被“抹平”，从而不影响 image-to-text 模型的正常识别。
## **Stable Diffusion**
### 训练 Lora 模型
使用一位特定画师的几幅作品及其对应的自动生成的文本描述作为训练集，如此一来，使用该 Lora 模型应当能生成具有该画师画风的图像。  
![Alt text](4-1.jpg)  
训练3000步，loss 曲线如下图所示：
![Alt text](5.png)  
使用相同参数和提示词生成图像，效果如图所示：  
![Alt text](6-1.jpg)  
可以看出，使用训练后的Lora模型，生成图像的画风向该画师的画风变化。   
### 使用 Controlnet  
对于相同提示词和参数，使用 Controlnet 能显著调整画面。
![Alt text](8.jpg)  
上图为未使用 Controlnet 的生成结果。
![Alt text](7-1.jpg)  
上图为使用 Controlnet 的生成结果。